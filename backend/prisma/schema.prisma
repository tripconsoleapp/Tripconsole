generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ORGANIZER
  OPERATOR
  FIELD_COORDINATOR
  ADMIN
}

enum VerificationLevel {
  UNVERIFIED
  VERIFIED_IDENTITY
  VERIFIED_BACKGROUND
}

model User {
  id                String            @id @default(uuid())
  email             String?           @unique
  phone             String?           @unique
  password          String?
  role              Role
  verificationLevel VerificationLevel @default(UNVERIFIED)

  isActive          Boolean           @default(true)
  
  failedLoginAttempts Int             @default(0)
  lockUntil         DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  deletedAt         DateTime?

  refreshTokenHash  String?
  trips             Trip[]
  auditLogs         AuditLog[]
  verifications     Verification[]
  reviewedVerifications Verification[] @relation("Reviewer")

  @@index([role])
}

//Trip Status and enum means custom datatype

enum TripStatus{
  DRAFT
  REVIEW
  SUBMITTED
  VERIFIED
  PAID
  COMPLETED
  CANCELLED
}

model Trip {
  id           String      @id @default(uuid())
  organizerId  String
  organizer    User        @relation(fields: [organizerId], references: [id])

  status       TripStatus  @default(DRAFT)
  version      Int         @default(1)

  costSnapshot Json?
  itinerarySnapshot Json?

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  deletedAt    DateTime?

  payment      Payment[]
  
  @@index([organizerId])
  @@index([status])
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

model Verification {
  id            String              @id @default(uuid())
  userId        String
  user          User                @relation(fields: [userId], references: [id])

  documentType  String              // PCC or REFERENCE
  documentUrl   String              // S3 link
  status        VerificationStatus  @default(PENDING)

  expiryDate    DateTime?
  rejectionReason String?

  reviewedById  String?
  reviewedBy    User?               @relation("Reviewer", fields: [reviewedById], references: [id])

  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([userId])
  @@index([status])
}

enum PaymentStatus {
  CREATED
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

model Payment {
  id              String         @id @default(uuid())

  tripId          String
  trip            Trip           @relation(fields: [tripId], references: [id])

  amount          Int            // store in smallest currency unit (paise)
  currency        String         @default("INR")

  gateway         String         // RAZORPAY / STRIPE
  gatewayOrderId  String?        @unique
  gatewayPaymentId String?       @unique

  status          PaymentStatus  @default(CREATED)

  rawResponse     Json?          // store webhook payload safely

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([tripId])
  @@index([status])
}

enum AuditAction {
  LOGIN_SUCCESS
  LOGIN_FAILED
  ACCOUNT_LOCKED
  TOKEN_REFRESH
  LOGOUT
  ENTITY_UPDATE
  ENTITY_CREATE
  ENTITY_DELETE
  STATUS_UPDATED
}

model AuditLog {
  id          String      @id @default(uuid())

  userId      String?
  user        User?       @relation(fields: [userId], references: [id])

  action      AuditAction
  entityType  String?
  entityId    String?

  previousState Json?
  newState      Json?

  metadata     Json?
  ipAddress    String?
  userAgent    String?

  createdAt    DateTime   @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([entityId])
}

